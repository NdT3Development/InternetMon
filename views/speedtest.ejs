<!DOCTYPE html>
<html>
	<head>
		<title>Speedtest</title>
		<link rel="stylesheet" href="/assets/Chart.css" />
	</head>
	<body>
		<canvas id="Chart1"></canvas>
		<script src="/assets/Chart.min.js"></script>
		<script src="/assets/moment.min.js"></script>
		<script>
			var data;
			function getParameterByName(name, url) {
				if (!url) url = window.location.href;
				name = name.replace(/[\[\]]/g, '\\$&');
				var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
					results = regex.exec(url);
				if (!results) return null;
				if (!results[2]) return '';
				return decodeURIComponent(results[2].replace(/\+/g, ' '));
			}

			var xhr = new XMLHttpRequest();
			var xhr = new XMLHttpRequest();
			if (getParameterByName('d') && parseInt(getParameterByName('d')) < 30) {
				console.log('d');
				var d = parseInt(getParameterByName('d'));
				xhr.open('GET', `/api/speedtest?d=${d}`);
				console.log('/api/speedtest?d='+d);
			} else if (getParameterByName('h') && parseInt(getParameterByName('h')) < 24) {
				console.log('h');
				var h = parseInt(getParameterByName('h'));
				xhr.open('GET', `/api/speedtest?h=${h}`); // ?h=${h} doesn't work for some reason
				console.log(`/api/speedtest?h=${h}`);
			} else {
				console.log('n');
				xhr.open('GET', '/api/speedtest');
			}
			xhr.onload = function() {
				data = JSON.parse(this.responseText);
				var lineChartData = {
					labels: [],
					datasets: [
						{
							label: 'Download',
							borderColor: 'purple',
							backgroundColor: 'transparent',
							spanGaps: false,
							data: []
						},
						{
							label: 'Upload',
							borderColor: 'cyan',
							backgroundColor: 'transparent',
							spanGaps: false,
							data: []
						}
					]
				};
				
				for (var i=0;i<data.length;i++) {
					lineChartData.labels.push(moment.unix(data[i].timestamp==0?'u':data[i].timestamp).format('D MMM YY HH:mm'));
					lineChartData.datasets[0].data.push(data[i].download==0?'u':data[i].download);
					lineChartData.datasets[1].data.push(data[i].upload==0?'u':data[i].upload);
				}

				ctx = document.getElementById("Chart1").getContext("2d");
				var myLineChart = new Chart(ctx, {
					type: 'line',
					data: lineChartData,
					options: {
						responsive: true
					}
				});
			};

			xhr.send();
		</script>
	</body>
</html>